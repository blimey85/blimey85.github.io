<!DOCTYPE html><html class="no-js" lang="en"><head><meta charset="utf-8"><title alt="Gem: Consistency_fail - Ramblings on Rails"> Gem: Consistency_fail - Ramblings on Rails</title><meta name="author" content="Gary Traffanstedt"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="http://traffan.com/gem-consistency-fail/"><link href="/favicon.png" type="image/png" rel="icon"><link href="/atom.xml" rel="alternate" title="Ramblings on Rails" type="application/atom+xml"><meta name="twitter:card" content="summary_large_image"><meta property="og:type" content="website"><meta property="og:url" content="http://traffan.com/gem-consistency-fail/"><meta property="og:title" content="Gem: Consistency_fail - Ramblings on Rails"><link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"></head><body> <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a><div id="wrap"> <header id="body_header"> <nav class="navbar navbar-default" role="navigation"><div class="container"><div class="navbar-header"> <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Ramblings on Rails</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li class="active"> <a rel="index" href="/">Blog</a></li><li > <a rel="index" href="/resources.html">Resources</a></li><li > <a href="/archives">Archives</a></li></ul><ul class="nav navbar-nav navbar-right"><li><form class="search navbar-form navbar-right" action="/search"><div class="form-group"> <input class="form-control"  id="search-query" name="q" placeholder="Search" autocomplete="off"></div></form></li></ul></div></div> </nav></header><div id="main" role="main" class="container"><section class="panel panel-default clearfix" id="search-results" style="display:none"><div class="panel-heading"><h3 class="panel-title">Search results</h3></div><div class="entries"></div> </section><div id="content"><div class="row"><div class="page-content col-md-8" itemscope itemtype="http://schema.org/Blog"><meta itemprop="name" content="Ramblings on Rails"/><meta itemprop="url" content="http://traffan.com"/> <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"> <header class="page-header"><h2 class="entry-title" itemprop="name headline"> <a>Gem: Consistency_fail</h2><hr><div class="post_meta"><ul><li class="time"><i class="fa fa-calendar"></i> <time datetime="2013-04-20T09:24:09-04:00" data-updated="true" itemprop="datePublished dateCreated">Sat 20 Apr 2013</time></li><li class="categories"><i class="fa fa-list"></i>  <span class="categories"> <a class='category' href='/categories/development/'>development</a> </span></li><li class="tags"><i class="fa fa-tags"></i>  <span class="tags"> <a class='tag' href='/tags/gems/'>gems</a> </span></li></ul></div> </header><div class="entry-content clearfix" itemprop="articleBody description"><p>In rails it’s common to add a <code>validates_uniqueness_of</code> validation to models for any fields that you want to be unique. Most of the time this is sufficient and will catch when a record is submitted that already exists. But what if two submissions come in at the same time? What if a user while registering clicks the submit button multiple times? You could run into a case where rails checks for uniqueness multiple times before the first record has time to be saved in the database, sees that they are in fact, at that point in time, unique, and allows them to go through. The database doesn’t know you want them to be unique so it gladly accepts them, and now your formerly pristine database is pristine no more.</p><p>Enter this nifty little gem: <a href="https://github.com/trptcolin/consistency_fail">consistency_fail</a>.</p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span></pre></td><td class='code'><pre><code class=''><span class='line'>gem install consistency_fail</span></code></pre></td></tr></table></div></figure><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span></pre></td><td class='code'><pre><code class=''><span class='line'>➜  bucketlist git:(master) ✗ consistency_fail
</span><span class='line'>
</span><span class='line'>There are calls to validates_uniqueness_of that aren't backed by unique indexes.
</span><span class='line'>--------------------------------------------------------------------------------
</span><span class='line'>Model                      Table Columns
</span><span class='line'>--------------------------------------------------------------------------------
</span><span class='line'>ActsAsTaggableOn::Tag      tags (name)
</span><span class='line'>ActsAsTaggableOn::Tagging  taggings (tag_id, taggable_type, taggable_id, context, tagger_id, tagger_type)
</span><span class='line'>User                       users (username)
</span><span class='line'>--------------------------------------------------------------------------------
</span><span class='line'>
</span><span class='line'>Hooray! All calls to has_one are correctly backed by a unique index.</span></code></pre></td></tr></table></div></figure><p>In my initial usage I had three indices that needed to be added. I quickly created two migrations (one for tags and taggings as they are related, and one for users) and then ran the tool again:</p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span></pre></td><td class='code'><pre><code class=''><span class='line'>➜  bucketlist git:(master) ✗ consistency_fail
</span><span class='line'>Hooray! All calls to validates_uniqueness_of are correctly backed by a unique index.
</span><span class='line'>
</span><span class='line'>Hooray! All calls to has_one are correctly backed by a unique index.</span></code></pre></td></tr></table></div></figure><p>Now sure, I know some of you will say that these indices should be created when you add the validation to the model and by doing that you don’t need a gem such as this one, but who among us is 100% effective in never forgetting little things like this? You create your table, build out a form, realize you want a couple of fields unique so you update your model, “oh, I need to add an index to the db… I’ll do that as soon as I’m done with…” and you forget all about it. We’ve all been there. But now we have <a href="https://github.com/trptcolin/consistency_fail">consistency_fail</a> to help us with such things.</p></div><footer><div class="sharing"></div><ul class="meta text-muted pager"><li class="previous"><a href="/nested-models-vs-monolithic/" title="Previous: Nested Models vs Monolithic">← Previous</a></li><li class="next"><a href="/octopress-tapir/" title="Next: Octopress Tapir">Next →</a></li></ul> </footer> </article></div> <aside class="sidebar col-md-4"> <section class="panel panel-default clearfix"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-user-secret"></i>  About Gary Traffanstedt</h3></div><p class="profile"> <img class="profile" src="/images/profile.jpeg"> A former and apsiring web programmer who is often rambling incessantly about Ruby on Rails, Javascript, and other things nobody else cares about. This blog takes place between the past and the present. Posts occur in real time.</p> </section> <section class="panel panel-default"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-pencil-square-o"></i>  Recent Posts</h3></div><div id="recent_posts" class="list-group"> <a class="list-group-item" href="/issues-with-caching/">Issues With Caching</a> <a class="list-group-item" href="/bug-in-apples-command-line-tools-6-dot-3/">Bug in Apple&#8217;s Command Line Tools 6.3</a> <a class="list-group-item" href="/the-return-of-the-great-white-hope/">The Return of the Great White Hope.</a> <a class="list-group-item" href="/haml-is-not-for-assets/">HAML Is Not for ASSETS</a> <a class="list-group-item" href="/counter-caching/">Counter Caching</a></div> </section> <section class="panel panel-default"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-list"></i>  Categories</h3></div><div class="list-group"> <a class="list-group-item" href="/categories/development/index.html"> <span class="badge">14</span> development </a> <a class="list-group-item" href="/categories/hardware/index.html"> <span class="badge">1</span> hardware </a> <a class="list-group-item" href="/categories/blogging/index.html"> <span class="badge">4</span> blogging </a></div> </section><section class="panel panel-default"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-1_2x fa-tags"></i>  Tag Cloud</h3></div><div class="list-group"><div id="myCanvasContainer" style="text-align:center"> <canvas width="300" height="300" id="myCanvas"><p>Anything in here will be replaced on browsers that support the canvas element</p> </canvas></div><div id="tags" style="display:none"><ul><li> <a href="/tags/delayed_job" style="font-size:4pt"> delayed_job </a></li><li> <a href="/tags/rails" style="font-size:34pt"> rails </a></li><li> <a href="/tags/ruby" style="font-size:4pt"> ruby </a></li><li> <a href="/tags/apple" style="font-size:8pt"> apple </a></li><li> <a href="/tags/shiny" style="font-size:4pt"> shiny </a></li><li> <a href="/tags/toys" style="font-size:4pt"> toys </a></li><li> <a href="/tags/brew" style="font-size:4pt"> brew </a></li><li> <a href="/tags/mac" style="font-size:4pt"> mac </a></li><li> <a href="/tags/mysql" style="font-size:4pt"> mysql </a></li><li> <a href="/tags/postgresql" style="font-size:8pt"> postgresql </a></li><li> <a href="/tags/path" style="font-size:4pt"> path </a></li><li> <a href="/tags/puma" style="font-size:4pt"> puma </a></li><li> <a href="/tags/appfog" style="font-size:4pt"> appfog </a></li><li> <a href="/tags/coffeeScript" style="font-size:4pt"> coffeeScript </a></li><li> <a href="/tags/jquery" style="font-size:4pt"> jquery </a></li><li> <a href="/tags/features" style="font-size:4pt"> features </a></li><li> <a href="/tags/gems" style="font-size:13pt"> gems </a></li><li> <a href="/tags/octopress" style="font-size:8pt"> octopress </a></li><li> <a href="/tags/search" style="font-size:4pt"> search </a></li><li> <a href="/tags/tapir" style="font-size:4pt"> tapir </a></li><li> <a href="/tags/automation" style="font-size:4pt"> automation </a></li><li> <a href="/tags/twitter" style="font-size:4pt"> twitter </a></li><li> <a href="/tags/haml" style="font-size:4pt"> haml </a></li></ul></div></div> </section> <section class="panel panel-default clearfix"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-1_2x fa-twitter"></i>  Tweets</h3></div> <a class="twitter-timeline" height="450px" width="100%" data-chrome="noheader nofooter noborders noscrollbar" data-dnt="true" href="https://twitter.com/blimey85" data-widget-id="595102305114005504">Tweets by @blimey85</a> <script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="twitter-user gh-profile-link pull-right text-muted"> <a href="https://twitter.com/blimey85">@blimey85</a> on Twitter</div> </section><section class="panel panel-default clearfix"><div class="panel-heading"><h3 class="panel-title"><i class="fa fa-1_2x fa-github"></i>  GitHub Repos</h3></div><div class="list-group" id="gh_repos"> <a class="list-group-item" href="https://github.com/blimey85/blimey85.github.io">blimey85.github.io<br> <span class="repo_description">Blog @ Traffan.com</span></a> <a class="list-group-item" href="https://github.com/blimey85/blimey85.github.io_source">blimey85.github.io_source<br> <span class="repo_description">Source code for Traffan.com.</span></a> <a class="list-group-item" href="https://github.com/blimey85/octopress-tapir">octopress-tapir<br> <span class="repo_description">Plugin to enable Tapir search with Octopress blogs.</span></a> <a class="list-group-item" href="https://github.com/blimey85/try_git">try_git<br><span class="repo_description"></span></a></div><div class="gh-profile-link pull-right text-muted"> <a href="https://github.com/blimey85">@blimey85</a> on GitHub</div> </section> </aside></div></div></div></div> <footer role="contentinfo"><div class="container"> <span class="social-icons"> <a class="fa-twitter-cont" href="https://twitter.com/blimey85"><i class="fa fa-1_6x fa-twitter"></i></a> <a class="fa-facebook-cont" href="https://www.facebook.com/blimey85"><i class="fa fa-1_6x fa-facebook"></i></a> <a class="fa-skype-cont" href="skype:blimey85?call"><i class="fa fa-1_6x fa-skype"></i></a> <a class="fa-pinterest-cont" href="https://www.pinterest.com/blimey85/"><i class="fa fa-1_6x fa-pinterest"></i></a> <a class="fa-instagram-cont" href="https://instagram.com/blimey85/"><i class="fa fa-1_6x fa-instagram"></i></a> <a class="fa-dribbble-cont" href="https://dribbble.com/blimey85"><i class="fa fa-1_6x fa-dribbble"></i></a> <a class="fa-github-cont" href="https://github.com/blimey85"><i class="fa fa-1_6x fa-github"></i></a> <a class="fa-spotify-cont" href="https://spotify.com/blimey85"><i class="fa fa-1_6x fa-spotify"></i></a> <a class="fa-rss-cont" href="/atom.xml"><i class="fa fa-1_6x fa-rss"></i></a> </span><p class="text-muted credits"> Copyright © 2013-2015 · Gary Traffanstedt<br> <small> <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>, <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>. </small></p></div> </footer><script src="/assets/app-9a5ceae0096daa47f14e5a4ce0dc7da7.js"></script><script id="search-results-template" type="text/mustache">
  {{#entries}}
    <article>
      <h3>
        {{#date}}<small><time datetime="{{pubdate}}" pubdate>{{displaydate}}</time></small>{{/date}}
        <a href="{{url}}">{{title}}</a>
      </h3>
    </article>
  {{/entries}}
</script></body></html>